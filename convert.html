<!DOCTYPE html>
<html>
<head>
<title>Converter</title>
<script src="js/code_val.js"></script>
<script type="text/javascript">
    const spaces = " \t", cr_lf = "\r\n";
    const singleOperator = "()+-.*/=;,><?&";
    const allClears = singleOperator + spaces + cr_lf;
    function extractWords(code) {
        let quote = null, verse = "", wordArray = [];
        for(let i = 0;i < code.length;i++) {
            const char = code[i];
            if(quote != null) {
                if(char == quote) {
                    verse += quote;
                    if(verse.length > 0) {
                        wordArray.push(verse);
                    }
                    quote = null;
                    verse = "";
                } else {
                    verse += char;
                }
                continue;
            }
            if(char === '\'' || char === '"' || char === '`') {
                if(verse.length > 0) {
                    wordArray.push(verse);
                }
                verse = char;
                quote = char;
            } else if(allClears.includes(char)) {
                if(verse.length > 0) {
                    wordArray.push(verse);
                }
                if(cr_lf.includes(char) || singleOperator.includes(char)) {
                    // wordArray.push(new CodeVal(char));
                }
                wordArray.push(char);
                verse = "";
            } else {
                verse += char;
            }
        }
        return wordArray;
    }
    function parsePhpCodes(wordArray) {
        let inPhpCode = false;
        let phpCodeArray = [];
        let line = 1, chars = 0;
        const appendCode = (word) => {
            phpCodeArray.push(new CodeVal(word, line, chars));
        };
        for(let i = 0;i < wordArray.length;i++) {
            let word = wordArray[i], nextWord = wordArray[i + 1], next2Word = wordArray[i + 2];
            if(inPhpCode) {
                if(word == "&") {
                    if(phpCodeArray[phpCodeArray.length - 1].type == "Space" &&
                        phpCodeArray[phpCodeArray.length - 2].value == "function") {
                        continue;
                    }
                } else if(word == " ") {
                    for(let j = i + 1;j < wordArray.length;j++) {
                        let word2 = wordArray[j];
                        if(word2 == " ") {
                            word += word2;
                            i += 1;
                        } else {
                            appendCode(word);
                            break;
                        }
                    }
                } else if(word == "=" && nextWord == "&") {
                    appendCode("=");
                    i += 1;
                } else if(word == "-" && nextWord == ">") {
                    appendCode("->");
                    i += 1;
                } else if(word == "?" && wordArray[i + 1] == ">") {
                    inPhpCode = false;
                    appendCode(word + wordArray[i + 1]);
                    i += 1;
                } else {
                    appendCode(word);
                }
            } else {
                if(word == "<" && nextWord == "?" && next2Word == "php") {
                    inPhpCode = true;
                    appendCode("<?php");
                    i += 2;
                } else if(word == "<" && nextWord == "?" && next2Word != "php") {
                    inPhpCode = true;
                    appendCode("<?php");
                    i += 1;
                } else {
                    appendCode(word);
                }
            }

            if(word == "\n") {
                line += 1;
                chars = 0;
            } else {
                chars += word.length;
            }
        }
        return phpCodeArray;
    }
    function convert() {
        let code = document.getElementById('input').value;
        let wordArray = extractWords(code);
        let phpCodeArray = parsePhpCodes(wordArray);
        let distCode = "";
        for (let i = 0;i < phpCodeArray.length;i++) {
            console.log(phpCodeArray[i].to_s);
            distCode += phpCodeArray[i].value;
        }
        document.getElementById('output').value = distCode;
    }
</script>
</head>
<body>
<textarea id="input" style="width: 500px;height: 400px;">&lt;?php
/**
 * 古いくらす
 */
class TestClass1 {
    var $val = 100;
    var $text = "abcdefg";
    var $text2 = "ABC
DEFG";

    function add() {
        return $this->val + 97;
    }
    function minus() {
        return $this->val-85;
    }
    function &amp;my() {
        return $this;
    }
    function text() {
        return $this->text;
    }
}
$a =&amp; new TestClass1();
echo $a->val.PHP_EOL;
echo $a->add().PHP_EOL;
echo $a->minus().PHP_EOL;
echo $a->my().PHP_EOL;
echo $a->text().PHP_EOL;
?&gt;
</textarea>
<input type="button" value="Convert" onclick="convert()">
<textarea id="output" style="width: 500px;height: 400px;"></textarea>
</body>
</html>